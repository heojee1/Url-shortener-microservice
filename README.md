# Web Services and Cloud-Based Systems - Assignment 2
This is the reference implementation for the second assignment of the Web Services and Cloud-Based Systems course.

## Installation
To setup your machine to run the services, first prepare your machine by setting up a virtual environment with the required packages:
```bash
# Setup the virtual environment locally
python3 -m venv ./venv
# Activate it for your current terminal
. venv/bin/activate
# Your terminal now has '(venv)' prepended to the prompt

# Install the dependencies
pip3 install flask requests
```

You are now ready to run the services.


## Usage
### Starting the services
To run any service, first make sure you have activated the virtual environment (it has to say 'venv' at the start of your terminal):
```bash
. venv/bin/activate
# Your terminal now has '(venv)' prepended to the prompt
```

Then, you can start the services. Launch the users/login service first:
```bash
FLASK_APP=src/users python3 -m flask run --port 5001
```

After that, start the URL-shortener in a separate terminal:
```bash
FLASK_APP=src/url-shortener python3 -m flask run --port 5000
```

The services are now available under ports 5001 and 5000, respectively. To change the ports, change the value after the `--port` option in the two commands.


### Using the services
Both services implement a number of methods, which we will describe here. While this should align with the specification in the assignment, it might differ from how you have designed the methods; that's perfectly fine! They are left purposefully vague so you have some freedom to choose your own RESTful implementation during the assignment.

These methods are the ones that we have implemented for the users/login service:
- `/users` POST: Creates a new user with the given username and password. Both should be given as form fields in the POST-request (`username` for the username, and `password` for the password).
    - Returns `201` (Created) if the user was created successfully.
    - Returns `400` (Bad request) with the reason if something went wrong (any of the fields in the POST-request are missing).
    - Returns `409` (Conflict) if the user already exists. This is implemented to prevent anyone from simply overwriting someone else's password.
- `/users` PUT: Updates the password for a given user. A username must be specified in the `username` form field, the old password in the `old-password` field (for authentication), and the new password in the `new-password` field.
    - Returns `200` (OK) if the user's password was updated successfully.
    - Returns `400` (Bad request) with the reason if something went wrong (any of the fields in the POST-request are missing).
    - Returns `403` (Forbidden) if the user provided the wrong password.
    - Returns `404` (Not found) if the provided user did not exist.
- `/users/login` POST: Tries to login an existing user by giving a username and its matching password (as form fields in the POST-request: `username` for the username and `password` for the password).
    - Returns `200` (OK) and a JWT on success. Note that, if the user was already logged-in, the same JWT is returned.
    - Returns `400` (Bad request) with the reason if something went wrong (any of the fields in the POST-request are missing).
    - Returns `403` (Forbidden) if the given password does not match for the given user or the given user does not exist.
- `/tokens` POST: Verifies the JWT given in the form field `token` by matching its signature. **Note:** The proper HTTP method for this function is a bit ambigious, since we aren't really touching the service's database here. That said, GET would probably have been most appropriate, except for the fact that it puts the token in the HTTP path. To keep the token more private, POST was chosen to be able to hide it in a form field.
    - Returns `200` (OK) and the JSON-encoded username if the token was valid. Alternatively, if there is any reason the token was invalid (also if it is malformed), returns `200` (OK) and the JSON null.
    - Returns `400` (Bad request) with the reason if something went wrong (any of the fields in the POST-request are missing).

For the URL-shortening service, we have added a requirement to have an `Authorization` HTTP header defined for all methods (except `/:id` GET). This header contains the JWT generated by the users/login service.
The following methods have been implemented:
- `/` GET: Returns all the keys currently registered to the user who owns the JWT as a JSON file.
    - Returns `200` (OK) and a JSON file of the following form on success:
      ```json
      {
          "keys": [ "key1", "key2", ... ]
      }
      ```
      Note that the list might be empty.
    - Returns `403` (Forbidden) if the JWT in the `Authorization` header was invalid or missing, or if this service failed to reach the authentication service.
- `/` POST: Creates a new, shortened URL for the given URL by generating a new key. Will be linked to the owner of the JWT. Requires a `url` field with the URL to add.
    - Returns `201` (Created) and the new key on success.
    - Returns `400` (Bad request) with the reason if something went wrong (no `url`-field given or the `url` is not validated correctly).
    - Returns `403` (Forbidden) if the JWT in the `Authorization` header was invalid or missing, or if this service failed to reach the authentication service.
- `/` DELETE: Deletes all keys for the owner of the JWT in the shortener.
    - Returns `204` (No content) if at least one key was deleted.
    - Returns `403` (Forbidden) if the JWT in the `Authorization` header was invalid or missing, or if this service failed to reach the authentication service.
    - Returns `404` (Not found) if there was nothing to delete.
- `/:id` GET: Returns the long URL behind the shortened URL by redirecting the web browser.
    - Returns `301` (Moved permanently) with the long URL to redirect the browser.
    - Returns `404` (Not found) if there is no such shortened URL.
- `/:id` PUT: Updates the given ID with a new URL, stored in a `url`-field.
    - Returns `200` (OK) if the update was successfull.
    - Returns `400` (Bad request) with the reason why if something went wrong (no `url`-field given or the `url` is not validated correctly).
    - Returns `403` (Forbidden) if the JWT in the `Authorization` header was invalid or missing, or if this service failed to reach the authentication service.
    - Returns `404` (Not found) if there is no such shortened URL.
- `/:id` DELETE: Deletes the given ID.
    - Returns `204` (No content) if the removal was successfull.
    - Returns `403` (Forbidden) if the JWT in the `Authorization` header was invalid or missing, or if this service failed to reach the authentication service.
    - Returns `404` (Not found) if there is no such shortened URL.

## Documentation
The users service is implemented in `src/users.py`, and the updated URL-shortener in `src/url-shortener.py`. Both files include comments that explain what they do. We recommend to take a look there if you want to understand the how the services work.
